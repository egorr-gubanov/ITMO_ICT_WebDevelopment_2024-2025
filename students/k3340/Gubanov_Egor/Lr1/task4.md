# –ó–∞–¥–∞–Ω–∏–µ 4: –ú–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ß–∞—Ç

## –ü—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ

–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –¥–≤—É—Ö–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –∏–ª–∏ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Ç. –î–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –±–∞–ª–ª–æ–≤ —Ä–µ–∞–ª–∏–∑—É–π—Ç–µ –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Ç.

### –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è:
- –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `socket`
- –î–ª—è –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ —á–∞—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É `threading`

### –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:
- **–ü—Ä–æ—Ç–æ–∫–æ–ª TCP:** 100% –±–∞–ª–ª–æ–≤
- **–ü—Ä–æ—Ç–æ–∫–æ–ª UDP:** 80% –±–∞–ª–ª–æ–≤
- –î–ª—è UDP –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ threading –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
- –î–ª—è TCP –∑–∞–ø—É—Å—Ç–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –≤ –ø–æ—Ç–æ–∫–∞—Ö. –ù–µ –∑–∞–±—É–¥—å—Ç–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∏–º —Å–æ–æ–±—â–µ–Ω–∏—è

### –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏:
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è Python: threading](https://docs.python.org/3/library/threading.html)
- [WebDevBlog: –í–≤–µ–¥–µ–Ω–∏–µ –≤ –ø–æ—Ç–æ–∫–∏ Python](https://webdevblog.ru/vvedenie-v-potoki-python/)

---

## –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

### –°–µ—Ä–≤–µ—Ä (task4/server.py)

```python
import socket
import threading
import time
from datetime import datetime

# –°–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
clients = []
clients_lock = threading.Lock()

def broadcast_message(message, sender_conn=None):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º –∫—Ä–æ–º–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è"""
    with clients_lock:
        for conn, name in clients:
            if conn != sender_conn:
                try:
                    conn.sendall(message.encode('utf-8'))
                except:
                    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, —É–¥–∞–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞
                    clients.remove((conn, name))

def handle_client(conn, addr):
    """–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞"""
    global clients
    
    try:
        # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∫–ª–∏–µ–Ω—Ç–∞
        name = conn.recv(1024).decode('utf-8')
        if not name:
            return
            
        with clients_lock:
            clients.append((conn, name))
        
        print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É")
        broadcast_message(f"üîµ {name} –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É", conn)
        
        while True:
            try:
                message = conn.recv(1024).decode('utf-8')
                if not message:
                    break
                    
                if message == '/quit':
                    break
                
                # –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
                timestamp = datetime.now().strftime('%H:%M:%S')
                full_message = f"[{timestamp}] {name}: {message}"
                
                print(full_message)
                broadcast_message(full_message, conn)
                
            except ConnectionResetError:
                break
            except Exception as e:
                print(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç {name}: {e}")
                break
                
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞ {addr}: {e}")
    finally:
        # –£–¥–∞–ª—è–µ–º –∫–ª–∏–µ–Ω—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞
        with clients_lock:
            for i, (client_conn, client_name) in enumerate(clients):
                if client_conn == conn:
                    clients.pop(i)
                    print(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å {client_name} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç")
                    broadcast_message(f"üî¥ {client_name} –ø–æ–∫–∏–Ω—É–ª —á–∞—Ç", conn)
                    break
        
        conn.close()

def run_server():
    with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as server_socket:
        server_socket.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        server_socket.bind(('127.0.0.1', 8004))
        server_socket.listen(5)
        
        print("–ß–∞—Ç-—Å–µ—Ä–≤–µ—Ä")
        print("=" * 20)
        print(f"–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8004...")
        print(f"–ü—Ä–æ—Ç–æ–∫–æ–ª: TCP")
        print(f"–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å: –í–∫–ª—é—á–µ–Ω–∞")
        print("\n–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...")
        print("–ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏...")
        
        try:
            while True:
                conn, addr = server_socket.accept()
                print(f"–ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç {addr}")
                
                # –°–æ–∑–¥–∞–µ–º –ø–æ—Ç–æ–∫ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–ª–∏–µ–Ω—Ç–∞
                client_thread = threading.Thread(
                    target=handle_client, 
                    args=(conn, addr),
                    daemon=True
                )
                client_thread.start()
                
        except KeyboardInterrupt:
            print("\n–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞...")
            with clients_lock:
                for conn, name in clients:
                    conn.close()
            print("–°–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω")

if __name__ == "__main__":
    run_server()
```

### –ö–ª–∏–µ–Ω—Ç (task4/client.py)

```python
import socket
import threading
import sys

def receive_messages(client_socket):
    """–ü–æ–ª—É—á–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø–æ—Ç–æ–∫–µ"""
    while True:
        try:
            message = client_socket.recv(1024).decode('utf-8')
            if not message:
                break
            print(f"\n{message}")
            print("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ /quit –¥–ª—è –≤—ã—Ö–æ–¥–∞): ", end="", flush=True)
        except ConnectionResetError:
            print("\n–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–æ–º —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ")
            break
        except Exception as e:
            print(f"\n–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
            break

def run_client():
    try:
        with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as client_socket:
            # –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É
            client_socket.connect(('127.0.0.1', 8004))
            
            # –ü–æ–ª—É—á–∞–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            name = input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è: ").strip()
            if not name:
                name = "–ê–Ω–æ–Ω–∏–º"
            
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–º—è —Å–µ—Ä–≤–µ—Ä—É
            client_socket.sendall(name.encode('utf-8'))
            
            print(f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç, {name}!")
            print("–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ /quit –¥–ª—è –≤—ã—Ö–æ–¥–∞): ", end="", flush=True)
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º –ø–æ—Ç–æ–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
            receive_thread = threading.Thread(
                target=receive_messages, 
                args=(client_socket,),
                daemon=True
            )
            receive_thread.start()
            
            # –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
            while True:
                try:
                    message = input()
                    
                    if message == '/quit':
                        client_socket.sendall(message.encode('utf-8'))
                        break
                    
                    if message.strip():
                        client_socket.sendall(message.encode('utf-8'))
                        
                except KeyboardInterrupt:
                    print("\n–í—ã—Ö–æ–¥...")
                    client_socket.sendall('/quit'.encode('utf-8'))
                    break
                except Exception as e:
                    print(f"–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è: {e}")
                    break
                    
    except ConnectionRefusedError:
        print("–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É")
        print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω")
    except Exception as e:
        print(f"–û—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    run_client()
```

## –ó–∞–ø—É—Å–∫

1. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:**
   ```bash
   python task4/server.py
   ```

2. **–ó–∞–ø—É—Å—Ç–∏—Ç–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ —Ä–∞–∑–Ω—ã—Ö —Ç–µ—Ä–º–∏–Ω–∞–ª–∞—Ö:**
   ```bash
   python task4/client.py
   ```

3. **–í –∫–∞–∂–¥–æ–º –∫–ª–∏–µ–Ω—Ç–µ:**
   - –í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è
   - –ù–∞—á–∏–Ω–∞–π—Ç–µ –æ–±—â–∞—Ç—å—Å—è!

## –†–µ–∑—É–ª—å—Ç–∞—Ç

**–°–µ—Ä–≤–µ—Ä:**
```
–ß–∞—Ç-—Å–µ—Ä–≤–µ—Ä
====================
–°–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 8004...
–ü—Ä–æ—Ç–æ–∫–æ–ª: TCP
–ú–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å: –í–∫–ª—é—á–µ–Ω–∞

–û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–π...
–ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç ('127.0.0.1', 54321)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ê–ª–∏—Å–∞ –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É
–ù–æ–≤–æ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç ('127.0.0.1', 54322)
–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ë–æ–± –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏–ª—Å—è –∫ —á–∞—Ç—É
[14:30:15] –ê–ª–∏—Å–∞: –ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!
[14:30:18] –ë–æ–±: –ü—Ä–∏–≤–µ—Ç, –ê–ª–∏—Å–∞!
```

**–ö–ª–∏–µ–Ω—Ç 1 (–ê–ª–∏—Å–∞):**
```
–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è: –ê–ª–∏—Å–∞
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç, –ê–ª–∏—Å–∞!
–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ /quit –¥–ª—è –≤—ã—Ö–æ–¥–∞): –ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!

[14:30:18] –ë–æ–±: –ü—Ä–∏–≤–µ—Ç, –ê–ª–∏—Å–∞!
```

**–ö–ª–∏–µ–Ω—Ç 2 (–ë–æ–±):**
```
–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è: –ë–æ–±
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç, –ë–æ–±!

[14:30:15] –ê–ª–∏—Å–∞: –ü—Ä–∏–≤–µ—Ç –≤—Å–µ–º!
–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–∏–ª–∏ /quit –¥–ª—è –≤—ã—Ö–æ–¥–∞): –ü—Ä–∏–≤–µ—Ç, –ê–ª–∏—Å–∞!
```

## –í—ã–≤–æ–¥—ã

1. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π —á–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π TCP –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –º–Ω–æ–≥–æ–ø–æ—Ç–æ—á–Ω–æ—Å—Ç—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
3. –î–æ–±–∞–≤–ª–µ–Ω–∞ —Å–∏—Å—Ç–µ–º–∞ –∏–º–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫
4. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ç—Ä–∞–Ω—Å–ª—è—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º —á–∞—Ç–∞
5. –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏–π –∫–ª–∏–µ–Ω—Ç–æ–≤
6. –ß–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–µ–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤
